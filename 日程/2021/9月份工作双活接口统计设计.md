# 接口统计设计
## 一、需求
按照域名分组统计各个域名的qps、响应时间、状态码、body大小以及同环比。  
按照项目和接口分组统计各个接口的qps、响应时间、状态码、body大小以及同环比
## 二、设计
### 1、基础信息配置
#### ES的索引和click house的库
切换到click house基本分组模块为库，现有设计是一个服务一个库。  
对应实际业务：应用的nginx——>all_appstore_tenant_appstore_nginx_svc  
问题：这个库不好维护  
添加时永福控制添加，且目前有很多废库。  
这里手动维护还是获取所有的库，然后自行过滤掉废弃的？（不管哪个方法，都需要手动维护一张表）  

#### click house的库和namespace的关系
可以沿用一个库对应一个namespace。从目前线上统计来看，也是这么设计的，每个库对应一个namespace。这个对应关系，在数据库click house库表里面加上即可
增加：
ckhbase——clickhouse中的库名
datacenter——机房
删除：
k8s_version。这是当初容器云无法原地升级才增加的，以后不会有这种情况了。

#### 机房表
应该是得要一个。这个看cmdb要不要接入clickhouse，如果接入的话，从cmdb直接拿。

#### api表的设计
沿用原版本字段。
只不过原来的es_index_id对应ES索引，新增一个clickhouse字段对应click house的库名。
删除：
collect_cycle。该字段在逻辑里根本没有用  
capacity。该字段没有用
path_flag。该字段没有用

新增：
restime_low
restime_middle
restime_high
body_small
body_large
bodysize_flag

#### 小流量表
将es_index改为ckhbase

#### 历史记录表
不变

### 2、按域名统计
click house已经将域名写入，但是只有gateway的，别的业务没有。  
但是其他业务多半只用一个域名，购物有两个。
问题：
这个域名怎么维护？
可以打tag里面，用的时候不影响。但是要统计的话，出不来
方案1：做一个域名表。字段要包括库、namespace。统计的时候，从这张表取。另外准备一个脚本，每天更新，如果有新域名，自动插入。
方案2：手动维护一下

状态码、body大小、响应时间、同环比，都放到这张表里面。这个表字段对照现有api表字段规划。要增加一个机房字段

### 3、按API统计
按照现有表，照搬

### 4、bodysize的计算
把指定接口的流量大小计算出来。
原来是按租户项目计算，计划改为按接口计算

## metric
#### 统计metric
|metric|tag|instruction|
|---|---|---|
|domain|domain, namespace, dc|通用tag|
|ckh.domain.qps|-|-|
|ckh.domain.statuscode|statuscode=2XX,3XX,4XX,5XX|固定四个value|
|ckh.domain.responsetime|level=quick, normal, slow, except|设置三个值，隔开区间|
|ckh.domain.bodysize|level=small, normal, large|设置两个值，隔开区间|
|api|api, namespace, dc|通用tag|
|ckh.api.qps|-|-|
|ckh.api.statuscode|statuscode=2XX,3XX,4XX,5XX|固定四个value|
|ckh.api.responsetime|level=quick, normal, slow, except|设置三个值，隔开区间|
|ckh.api.bodysize|level=small, normal, large|设置两个值，隔开区间|
|namespace|namespace, dc|这个和上面两个还是有去别的，上面的都是有限个域名或者接口。这个是统计全部的|
|ckh.namespace.qps|-|-|
|ckh.namespace.statuscode|statuscode=2XX,3XX,4XX,5XX|固定四个value|
|ckh.namespace.responsetime|level=quick, normal, slow, except|设置三个值，隔开区间|
|ckh.namespace.bodysize|level=small, normal, large|设置两个值，隔开区间|

namespace务必和库一一对应，不然这个metric就是有问题的。
#### 告警metric
|metric|instruction|
|---|---|
|ckh.domain.righttatuscode.percent|正常码比例|
|ckh.domain.rightresponsetime.percent|正常时间比例|
|ckh.domain.rightbodysize.percent|正常包比例|
|---|---|
|ckh.api.righttatuscode.percent|正常码比例|
|ckh.api.rightresponsetime.percent|正常时间比例|
|ckh.api.rightbodysize.percent|正常包比例|
|---|---|
|ckh.namespace.righttatuscode.percent|正常码比例|
|ckh.namespace.rightresponsetime.percent|正常时间比例|
|ckh.namespace.rightbodysize.percent|正常包比例|




