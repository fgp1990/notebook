# Plugin 脚本管理

2B 业务 plugin 可视化管理，安插到 fmp 里面。
原来是 ansible 定时推送，这个东西在第三方那边不方便，废掉。

## 一、功能列表

- plugin 脚本列表
- 脚本上传
- 脚本下发
- 策略下发
- 脚本关联服务器——在哪些服务器上

##### 1. 脚本列表包含信息

脚本名字、脚本地址、脚本参数(目前应该没有)、注解、关联服务器(这个很重要，也很繁琐)

##### 2.脚本上传

支持文件上传就行了

##### 3. 脚本下发

全量下发，具体怎么实现再议

##### 4. 策略下发

区别于脚本下发，策略是指需要在本机执行的脚本。
由系统端提供接口然后由 telegraf 主动拉取，拉取的时候要自带 IP，以此过滤需要执行的脚本。

## 二、model 设计

字段列表：脚本名字、脚本位置、附加参数、执行频率、注释、关联服务器

关联服务器这个不晓得咋弄好。服务器信息在 cmdb 上，跨系统跨库能做多对多吗？
目前有几个方案：

1. 存一个正则
   满足正则条件的都下发
2. 存一个 IP 列表
   列表内的全下发
3. 存一个正则，并附带排除 IP 列表
   满足正则条件的对象，在此基础上排除列表里面的
4. 存两个 IP 列表
   一个存需要下发的，一个存要排除的。
   都有内容，就用下发减排除
   只有一个的，就按照列表内容该选选，该排除排除

这几个方案，正则有几个问题

- 一个正则是否能满足使用需求，能否把所有要下发的 IP 都包含进来？
- 如果要写正则，是不是要把所有要包括的 IP 先列出来，然后写。这样会不会遗漏
- 正则的使用难度要比之前提高很多

## 三、部分功能具体实现

### 3.1 脚本上传

文件上传，存到本地。
这个本地怎么整？本来是有个 git 专门管的，git 不用了，ansible 要不要关联这个目录然后推送；或者要有别的推送方案

### 3.2 策略下发

单独搞个接口，请求时带上本机 IP，然后根据 IP 进行过滤，再下发回去。
这里就用到正则了

### 3.3 增删改查

### 3.4 新增目录

要考虑一下，虽然用的少

脚本内容存数据库
数据库增加一个 history 表，用来存历史脚本，要有名字、路径、内容
telegraf 要能从 server 端下载脚本和执行策略
